<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    .a-enter-vr {
      display: none !important;
    }
    /* Add a basic fade-out for the loading screen for a smoother transition */
    #loading-screen.hidden {
      opacity: 0;
      transition: opacity 1s ease-out;
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">
  <div id="loading-screen" style="
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    font-family: sans-serif;
    color: white;
    background: rgba(0, 0, 0, 0.6);
    padding: 10px 20px;
    border-radius: 8px;
    z-index: 999;
    text-align: center;">
    Loading AR experience...<br>Please be mindful of your surroundings
  </div>

  <div style="position: absolute; top: 20px; left: 20px; z-index: 999;">
    <a href="https://www.instagram.com/qrcky/" target="_blank">
      <img src="./insta.png" alt="Instagram" style="height: 28px; opacity: 0.8; cursor: pointer;" />
    </a>
  </div>

  <button onclick="window.open('https://www.qrcky.net/originals-paintings-black-and-white-art', '_blank')" 
    style="position: absolute; top: 20px; right: 20px; padding: 6px 14px; font-size: 14px; background-color: rgba(0, 0, 0, 0.8); color: white; border: none; border-radius: 6px; cursor: pointer; z-index: 999; height: 40px;">
    Inquiry
  </button>

  <a-scene mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 1; filterMinCF: 0.001; filterBeta: 0.05; missTolerance: 10; warmupTolerance: 10"
            color-space="sRGB"
            renderer="precision: medium; antialias: false; colorManagement: true; physicallyCorrectLights: true"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-asset-item id="mayaModel" src="./maya.glb"></a-asset-item>
      <a-asset-item id="regretModel" src="./miss_regret.glb"></a-asset-item>
      <a-asset-item id="seedlessFruitModel" src="./seedless-fruit.glb"></a-asset-item>
      <a-asset-item id="mapisModel" src="./mapis.glb"></a-asset-item>
      <a-asset-item id="negusAnewModel" src="./negus-anew.glb"></a-asset-item>
      <a-asset-item id="ebonyModel" src="./ebony.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity light="type: ambient; intensity: 0.7; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 0.8; color: #ffffff; castShadow: true" position="1 1 1"></a-entity>
    <a-entity light="type: directional; intensity: 0.5; color: #ffffff" position="-1 1 1"></a-entity>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-gltf-model src="#mayaModel" position="0 0 0" scale="0.3 0.3 0.3" animation-mixer enhanced-tracking></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 1">
      <a-gltf-model src="#regretModel" position="0 0 -0.3" scale="0.3 0.3 0.3" animation-mixer enhanced-tracking></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 2">
      <a-gltf-model src="#seedlessFruitModel" position="0 0 0" scale="0.3 0.3 0.3" animation-mixer enhanced-tracking></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 3">
      <a-gltf-model src="#mapisModel" position="0 0 0" scale="0.3 0.3 0.3" animation-mixer enhanced-tracking></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 4">
      <a-gltf-model src="#negusAnewModel" position="0 0 0" scale="0.3 0.3 0.3" animation-mixer enhanced-tracking></a-gltf-model>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 5">
      <a-gltf-model src="#ebonyModel" position="0 0 0" scale="0.3 0.3 0.3" animation-mixer enhanced-tracking></a-gltf-model>
    </a-entity>

  </a-scene>

  <script>
    // Enhanced tracking component
    AFRAME.registerComponent('enhanced-tracking', {
      init: function () {
        this.targetFound = false;
        this.positionBuffer = [];
        this.quaternionBuffer = [];
        this.maxBufferSize = 5; // Number of frames to average for position smoothing
        // Adjust this value! Higher = smoother but more lag. Lower = more reactive but more jitter.
        this.smoothingFactor = 0.3; // Recommended range: 0.1 to 0.8
        this.lastPosition = null;
        this.lastQuaternion = null;

        this.el.addEventListener('targetFound', () => {
          this.targetFound = true;
          this.positionBuffer = []; // Clear buffers on target found
          this.quaternionBuffer = [];
          // Initialize last position/quaternion with current values to start smoothing smoothly
          this.lastPosition = this.el.object3D.position.clone();
          this.lastQuaternion = this.el.object3D.quaternion.clone();
          console.log('✅ Target found: Initializing smoothing');
        });

        this.el.addEventListener('targetLost', () => {
          this.targetFound = false;
          console.log('❌ Target lost: Stopping smoothing');
        });
      },
      tick: function () {
        if (!this.targetFound) return;

        // Get the current raw position and quaternion from MindAR's tracking
        const currentPosition = this.el.object3D.position.clone(); // IMPORTANT: clone to work with a copy
        const currentQuaternion = this.el.object3D.quaternion.clone(); // IMPORTANT: clone to work with a copy

        // If this is the very first tick after targetFound, just set and return
        if (!this.lastPosition || !this.lastQuaternion) {
            this.lastPosition = currentPosition.clone();
            this.lastQuaternion = currentQuaternion.clone();
            return; 
        }

        // Position smoothing using a moving average buffer
        this.positionBuffer.push(currentPosition);
        if (this.positionBuffer.length > this.maxBufferSize) {
          this.positionBuffer.shift(); // Remove the oldest position
        }

        let averagedPosition = new THREE.Vector3();
        if (this.positionBuffer.length > 0) {
          this.positionBuffer.forEach(pos => averagedPosition.add(pos));
          averagedPosition.divideScalar(this.positionBuffer.length);
        } else {
          averagedPosition.copy(currentPosition); // Fallback if buffer is empty (shouldn't happen with maxBufferSize > 0)
        }

        // Apply linear interpolation (LERP) for position smoothing
        // This makes the object smoothly move towards the averaged position
        this.el.object3D.position.lerp(averagedPosition, this.smoothingFactor);


        // Rotation smoothing using spherical linear interpolation (SLERP)
        // This smoothly interpolates the object's current rotation towards the raw current rotation
        this.el.object3D.quaternion.slerp(currentQuaternion, this.smoothingFactor);

        // Update last known smoothed position and quaternion for the next tick's reference
        this.lastPosition.copy(this.el.object3D.position);
        this.lastQuaternion.copy(this.el.object3D.quaternion);
      }
    });

    const sceneEl = document.querySelector('a-scene');
    const loadingScreen = document.getElementById('loading-screen');

    // Function to hide loading screen
    const hideLoadingScreen = () => {
      loadingScreen.classList.add('hidden'); // Add class for fade-out
      loadingScreen.addEventListener('transitionend', () => {
        loadingScreen.style.display = 'none'; // Fully hide after transition
      }, { once: true });
      console.log('Loading screen hidden.');
    };

    // Listen for scene loaded event - reliable for A-Frame assets
    sceneEl.addEventListener('loaded', hideLoadingScreen);

    // Fallback timeout for loading screen - ensures it hides even if 'loaded' isn't fired
    setTimeout(hideLoadingScreen, 10000); // Hide after 10 seconds as a fallback

    // Renderer settings
    if (sceneEl.renderer) {
      sceneEl.renderer.setPixelRatio(window.devicePixelRatio || 1); // Use device pixel ratio for better quality
      sceneEl.renderer.sortObjects = false; // Generally good for AR
    }

    // Debugging console logs for target events
    sceneEl.addEventListener('targetFound', e => console.log('✅ Target found:', e.detail.targetIndex));
    sceneEl.addEventListener('targetLost', e => console.log('❌ Target lost:', e.detail.targetIndex));
  </script>
</body>
</html>
